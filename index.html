<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>အစားအသောက် မှာယူမှု App</title>
    <!-- Tailwind CSS အတွက် CDN လင့်ခ် -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 300ms, transform 300ms;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hide-on-client { display: none; }
        .hide-on-admin { display: none; }
        .is-admin-view .hide-on-client { display: block; }
        .is-admin-view .hide-on-admin { display: none; }
        .is-client-view .hide-on-client { display: none; }
        .is-client-view .hide-on-admin { display: block; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- App ရဲ့ အဓိက container -->
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading-screen" class="flex items-center justify-center min-h-screen">
            <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-lg">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-b-transparent border-orange-500"></div>
                <p class="mt-4 text-lg font-semibold text-gray-700">အချက်အလက်များ တင်နေသည်...</p>
            </div>
        </div>
        
        <!-- App Header (အဆင်သင့်ဖြစ်မှ ပြသမည်) -->
        <header id="app-header" class="hidden sticky top-0 bg-white shadow-sm z-50">
            <div class="container mx-auto p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-orange-600">အစားအသောက် မှာယူမှုစနစ်</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-id-display" class="text-sm text-gray-500 hidden md:inline"></span>
                    
                    <!-- Admin View သို့ သွားရန် ခလုတ် (Client View တွင်သာ ပြပါမည်) -->
                    <a href="#admin" class="hide-on-client flex items-center space-x-2 px-4 py-2 bg-orange-500 text-white rounded-full shadow-md hover:bg-orange-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat"><path d="M12 2a3 3 0 1 0 0 6 3 3 0 1 0 0-6z"/><path d="M17.5 7h-.5a3.5 3.5 0 0 0-3.5 3.5v7a3.5 3.5 0 0 1-3.5 3.5H10"/><path d="M15 17.5V20a2.5 2.5 0 0 0 5 0c0-2.5-1.5-5-5-5z"/><path d="M4.5 17H4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h11.5"/></svg>
                        <span>Admin View</span>
                    </a>

                    <!-- Client View သို့ ပြန်လာရန် ခလုတ် (Admin View တွင်သာ ပြပါမည်) -->
                    <a href="#" class="hide-on-admin flex items-center space-x-2 px-4 py-2 bg-gray-500 text-white rounded-full shadow-md hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>Client View</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Main Content Container -->
        <div id="main-content" class="container mx-auto p-4 hidden">
            <!-- Client View Content -->
            <div id="client-view" class="view-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">ကျွန်ုပ်တို့၏ မီနူး</h2>
                <div id="foods-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Food items will be dynamically inserted here -->
                </div>
            </div>

            <!-- Admin View Content -->
            <div id="admin-view" class="view-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">မှာယူမှုများ</h2>
                <p id="admin-message" class="text-center text-gray-500 hidden"></p>
                <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Orders will be dynamically inserted here -->
                </div>
                <hr class="my-10 border-gray-300" />
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">မီနူး စီမံခန့်ခွဲမှု</h2>
                    <button id="open-food-modal-btn" class="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-full shadow-md hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        <span>အသစ်ထည့်မည်</span>
                    </button>
                </div>
                <div id="food-management-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Food items with edit/delete buttons will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Order Modal -->
        <div id="order-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm modal-enter-active">
            <!-- Modal content will be dynamically inserted -->
        </div>

        <!-- Admin Password Modal -->
        <div id="admin-password-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm modal-enter-active">
            <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 max-h-screen overflow-y-auto animate-fade-in">
                <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Admin Password</h3>
                <form id="admin-password-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="admin-password-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Password ထည့်သွင်းပါ" required />
                        </div>
                    </div>
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden text-center">Password မမှန်ပါ</p>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" id="close-password-modal-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">ဖျက်သိမ်းမည်</button>
                        <button type="submit" class="px-6 py-3 bg-orange-500 text-white rounded-full font-semibold shadow-lg hover:bg-orange-600 transition-colors">ဝင်မည်</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Food Add/Edit Modal -->
        <div id="food-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm modal-enter-active">
            <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 max-h-screen overflow-y-auto animate-fade-in">
                <h3 id="food-modal-title" class="text-2xl font-bold text-gray-800 text-center mb-4"></h3>
                <form id="food-form">
                    <input type="hidden" id="food-id" />
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">အစားအသောက် အမည်</label>
                            <input type="text" id="food-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="အမည် ထည့်သွင်းပါ" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">စျေးနှုန်း (ကျပ်)</label>
                            <input type="number" id="food-price" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="စျေးနှုန်း ထည့်သွင်းပါ" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">အကြောင်းအရာ</label>
                            <textarea id="food-description" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="အကြောင်းအရာ ထည့်သွင်းပါ" rows="3" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ပုံ Link (URL)</label>
                            <input type="url" id="food-image-url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="ပုံ၏ URL ထည့်သွင်းပါ" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ပို့ဆောင်ခ (ကျပ်)</label>
                            <input type="number" id="food-delivery-fee" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="ပို့ဆောင်ခ ထည့်သွင်းပါ" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">လျှော့စျေး (%)</label>
                            <input type="number" id="food-discount-percent" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="လျှော့စျေး ထည့်သွင်းပါ" required />
                        </div>
                    </div>
                    <p id="food-modal-message" class="text-center text-sm mt-4"></p>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" id="close-food-modal-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">ဖျက်သိမ်းမည်</button>
                        <button type="submit" id="food-submit-btn" class="px-6 py-3 bg-orange-500 text-white rounded-full font-semibold shadow-lg hover:bg-orange-600 transition-colors"></button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm modal-enter-active">
            <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 max-h-screen overflow-y-auto animate-fade-in">
                <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">ဖျက်ရန် အတည်ပြုပါ</h3>
                <p class="text-gray-600 text-center">ဒီမီနူးကို ဖျက်ပစ်ဖို့ သေချာပါသလား။ ဒီလုပ်ရပ်ကို ပြန်ပြင်လို့မရနိုင်ပါဘူး။</p>
                <div class="mt-6 flex justify-center space-x-4">
                    <button type="button" id="cancel-delete-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">ဖျက်သိမ်းမည်</button>
                    <button type="button" id="confirm-delete-btn" class="px-6 py-3 bg-red-500 text-white rounded-full font-semibold shadow-lg hover:bg-red-600 transition-colors">ဖျက်ပစ်မည်</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Lucide icons အတွက် CDN လင့်ခ် -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.365.0/dist/umd/lucide.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, query, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Canvas environment မှ Firebase configuration ကိုအသုံးပြုခြင်း
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = '';
        let isAuthReady = false;

        // UI elements များ
        const loadingScreen = document.getElementById('loading-screen');
        const appHeader = document.getElementById('app-header');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const clientView = document.getElementById('client-view');
        const adminView = document.getElementById('admin-view');
        const foodsContainer = document.getElementById('foods-container');
        const ordersContainer = document.getElementById('orders-container');
        const adminMessage = document.getElementById('admin-message');
        const orderModal = document.getElementById('order-modal');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const passwordError = document.getElementById('password-error');
        const foodManagementContainer = document.getElementById('food-management-container');
        const foodModal = document.getElementById('food-modal');
        const foodModalTitle = document.getElementById('food-modal-title');
        const foodForm = document.getElementById('food-form');
        const foodSubmitBtn = document.getElementById('food-submit-btn');
        const foodModalMessage = document.getElementById('food-modal-message');
        const deleteModal = document.getElementById('delete-modal');

        // Admin Password ကို ဒီနေရာမှာ ပြောင်းနိုင်ပါတယ်
        const ADMIN_PASSWORD = 'admin123';
        const APP_ID = appId;
        
        let currentEditingFoodId = null;
        
        // Firebase ကို စတင်ပြီး authentication ကို ကိုင်တွယ်ခြင်း
        const initializeFirebase = async () => {
            console.log("Firebase ကို စတင်နေပါပြီ...");
            try {
                if (initialAuthToken) {
                    // Custom token ရှိရင် ဒါနဲ့ sign-in လုပ်ပါ
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Custom token ဖြင့် အောင်မြင်စွာ Sign-in လုပ်ပြီးပါပြီ။");
                } else {
                    // Custom token မရှိရင် Anonymous အဖြစ် sign-in လုပ်ပါ
                    await signInAnonymously(auth);
                    console.log("Anonymous အဖြစ် Sign-in လုပ်ပြီးပါပြီ။");
                }
                
                // onAuthStateChanged သည် user state ကို စတင်နားထောင်ပါသည်
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("User အောင်မြင်စွာ စစ်ဆေးပြီးပါပြီ:", userId);
                        updateUIOnAuthReady();
                    } else {
                        console.log("အသုံးပြုသူ အချက်အလက် မရှိပါ");
                    }
                });
            } catch (error) {
                console.error("Firebase စတင်ရာတွင် အမှားဖြစ်ပွားသည်:", error);
                isAuthReady = true; // Error ဖြစ်ရင်တောင် UI ကိုပြပြီး ဆက်လက်လုပ်ဆောင်ပါ
                updateUIOnAuthReady();
            }
        };

        // Firebase အဆင်သင့်ဖြစ်ပြီဆိုရင် UI ကို ပြသပေးခြင်း
        const updateUIOnAuthReady = () => {
            if (!isAuthReady) {
                console.error("Authentication မအောင်မြင်ပါ");
                return;
            }
            console.log("UI ကို စတင်ပြသပါပြီ");
            loadingScreen.classList.add('hidden');
            appHeader.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            userIdDisplay.textContent = `User ID: ${userId}`;
            // hash ကိုစစ်ပြီး သင့်တော်ရာ view ကို ပြပါ
            router();
            // Lucide icons များကို စတင်အသုံးပြုခြင်း
            lucide.createIcons();
        };

        // Router function for simple single-page application
        const router = () => {
            const hash = window.location.hash;
            if (hash === '#admin') {
                showAdminView();
            } else {
                showClientView();
            }
        };

        // hash ပြောင်းလဲမှုများကို နားထောင်ခြင်း
        window.addEventListener('hashchange', router);

        // Client view ကို ပြသခြင်း
        const showClientView = () => {
            mainContent.classList.remove('is-admin-view');
            mainContent.classList.add('is-client-view');
            clientView.style.display = 'block';
            adminView.style.display = 'none';
            renderClientViewContent();
        };

        // Admin view ကို ပြသခြင်း (password စစ်ဆေးမှုနှင့်အတူ)
        const showAdminView = () => {
            const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn') === 'true';
            if (isAdminLoggedIn) {
                mainContent.classList.remove('is-client-view');
                mainContent.classList.add('is-admin-view');
                clientView.style.display = 'none';
                adminView.style.display = 'block';
                renderAdminViewContent();
            } else {
                // Password မထည့်ရသေးရင် modal ကိုပြပါ
                adminPasswordModal.classList.remove('hidden');
            }
        };

        // Password Modal ပိတ်ရန်
        document.getElementById('close-password-modal-btn').addEventListener('click', () => {
            adminPasswordModal.classList.add('hidden');
            passwordError.classList.add('hidden');
            // မအောင်မြင်ရင် client view ကို ပြန်သွားပါ
            window.location.hash = '';
        });

        // Password Submit လုပ်ရန်
        document.getElementById('admin-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const passwordInput = document.getElementById('admin-password-input');
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                adminPasswordModal.classList.add('hidden');
                passwordError.classList.add('hidden');
                passwordInput.value = ''; // Password ကို ရှင်းလင်းပါ
                showAdminView(); // Admin View ကိုပြပါ
            } else {
                passwordError.classList.remove('hidden');
            }
        });

        // Firestore မှ အစားအသောက် အချက်အလက်များ ခေါ်ယူပြီး UI တွင် ပြသခြင်း
        const renderClientViewContent = () => {
            if (!isAuthReady) {
                console.log("Auth အဆင်သင့်မဖြစ်သေး၍ Client View ကို မပြသနိုင်သေးပါ");
                return; 
            }
            const foodCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/foods`);

            const checkAndAddSampleData = async () => {
                console.log("Sample data ကို စစ်ဆေးနေပါပြီ...");
                const docRef = doc(foodCollectionRef, "sample_food_1");
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.log("Sample data ကို ထည့်နေပါပြီ...");
                    await setDoc(docRef, {
                        name_mm: "ကြက်ကြော်",
                        price: 5000,
                        description_mm: "အကြွပ်ကြော်ထားသော အသားများ။ အရသာရှိပြီး အရည်ရွှမ်းသည်။",
                        image_url: "https://placehold.co/400x300/a2d2ff/000?text=ကြက်ကြော်",
                        delivery_fee: 1500,
                        discount_percent: 10,
                    });
                    await setDoc(doc(foodCollectionRef, "sample_food_2"), {
                        name_mm: "ဘာဂါ",
                        price: 6500,
                        description_mm: "အသားလွှာ၊ ဒိန်ခဲနှင့် ဟင်းသီးဟင်းရွက်များပါသော ဘာဂါ။",
                        image_url: "https://placehold.co/400x300/bde0fe/000?text=ဘာဂါ",
                        delivery_fee: 1500,
                        discount_percent: 10,
                    });
                    await setDoc(doc(foodCollectionRef, "sample_food_3"), {
                        name_mm: "ပင်လယ်စာ",
                        price: 8000,
                        description_mm: "ပုစွန်၊ ကမာ နှင့် ငါးများဖြင့် ပြင်ဆင်ထားသည်။",
                        image_url: "https://placehold.co/400x300/ffafcc/000?text=ပင်လယ်စာ",
                        delivery_fee: 1500,
                        discount_percent: 10,
                    });
                }
            };
            checkAndAddSampleData();

            onSnapshot(foodCollectionRef, (snapshot) => {
                foodsContainer.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const food = { id: doc.id, ...doc.data() };
                    const cardHtml = `
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-105 transition-transform duration-300">
                            <img src="${food.image_url}" alt="${food.name_mm}" class="w-full h-48 object-cover">
                            <div class="p-6">
                                <h3 class="text-xl font-bold text-gray-800">${food.name_mm}</h3>
                                <p class="text-2xl font-extrabold text-orange-500 my-2">${food.price} ကျပ်</p>
                                <p class="text-gray-600 text-sm mb-4">${food.description_mm}</p>
                                <button data-food-id="${food.id}" class="open-modal-btn w-full bg-orange-500 text-white py-3 rounded-full font-semibold shadow-md hover:bg-orange-600 transition-colors">
                                    Order မှာယူမည်
                                </button>
                            </div>
                        </div>
                    `;
                    foodsContainer.insertAdjacentHTML('beforeend', cardHtml);
                });

                document.querySelectorAll('.open-modal-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const foodId = button.dataset.foodId;
                        const selectedFood = snapshot.docs.find(doc => doc.id === foodId).data();
                        openOrderModal({ id: foodId, ...selectedFood });
                    });
                });
            });
        };

        // Firestore မှ မှာယူမှုများကို ခေါ်ယူပြီး UI တွင် ပြသခြင်း (Admin View)
        const renderAdminViewContent = () => {
            if (!isAuthReady) {
                console.log("Auth အဆင်သင့်မဖြစ်သေး၍ Admin View ကို မပြသနိုင်သေးပါ");
                return;
            }
            const ordersCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/orders`);
            const foodsCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/foods`);

            // Orders Listener
            onSnapshot(ordersCollectionRef, (snapshot) => {
                ordersContainer.innerHTML = '';
                if (snapshot.empty) {
                    adminMessage.classList.remove('hidden');
                    adminMessage.textContent = 'မှာယူမှု မရှိသေးပါ';
                } else {
                    adminMessage.classList.add('hidden');
                    snapshot.docs.forEach(doc => {
                        const order = { id: doc.id, ...doc.data() };
                        const statusDisplay = getStatusDisplay(order.status);
                        const paymentDisplay = getPaymentDisplay(order.paymentMethod);
                        const orderHtml = `
                            <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col space-y-4">
                                <div class="flex items-center space-x-3 text-orange-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                                    <h3 class="text-xl font-bold">${order.foodName_mm}</h3>
                                </div>
                                <p class="text-sm text-gray-600"><span class="font-semibold">Order ID:</span> ${order.id}</p>
                                <div class="border-t border-gray-200 pt-4 space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <span class="font-semibold">ဆက်သွယ်ရန်:</span>
                                        <span>${order.phoneNumber}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <span class="font-semibold">ပို့ရန်လိပ်စာ:</span>
                                        <span>${order.address}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <span class="font-semibold">ငွေချေမှု:</span>
                                        <div class="flex items-center space-x-1">
                                            ${paymentDisplay.icon}
                                            <span>${paymentDisplay.text}</span>
                                        </div>
                                    </div>
                                    ${order.paymentMethod !== 'cash' && order.transactionId ? `
                                        <div class="flex items-center space-x-2 text-gray-700">
                                            <span class="font-semibold">Transaction ID:</span>
                                            <span>${order.transactionId}</span>
                                        </div>
                                    ` : ''}
                                    ${order.paymentMethod !== 'cash' && order.paymentDate ? `
                                        <div class="flex items-center space-x-2 text-gray-700">
                                            <span class="font-semibold">ရက်စွဲ:</span>
                                            <span>${order.paymentDate}</span>
                                        </div>
                                    ` : ''}
                                    ${order.paymentMethod !== 'cash' && order.screenshot ? `
                                        <div class="pt-4">
                                            <p class="font-semibold text-sm text-gray-700 mb-2">ငွေပေးချေမှု၏ Screenshot</p>
                                            <img src="${order.screenshot}" alt="Payment Screenshot" class="w-full rounded-lg shadow-md border border-gray-200" />
                                        </div>
                                    ` : ''}
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <span class="font-semibold">အခြေအနေ:</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-bold flex items-center space-x-1 ${statusDisplay.style}">
                                            ${statusDisplay.icon}
                                            <span>${statusDisplay.text}</span>
                                        </span>
                                    </div>
                                    <div class="flex space-x-2 pt-4 justify-between text-sm">
                                        <button data-order-id="${order.id}" data-status="pending" class="update-status-btn flex-1 px-3 py-2 bg-yellow-400 text-white rounded-full font-semibold hover:bg-yellow-500 transition-colors ${order.status === 'pending' ? 'opacity-50 cursor-not-allowed' : ''}" ${order.status === 'pending' ? 'disabled' : ''}>
                                            ဆောင်ရွက်ဆဲ
                                        </button>
                                        <button data-order-id="${order.id}" data-status="in_delivery" class="update-status-btn flex-1 px-3 py-2 bg-blue-400 text-white rounded-full font-semibold hover:bg-blue-500 transition-colors ${order.status === 'in_delivery' ? 'opacity-50 cursor-not-allowed' : ''}" ${order.status === 'in_delivery' ? 'disabled' : ''}>
                                            ပို့ဆောင်နေသည်
                                        </button>
                                        <button data-order-id="${order.id}" data-status="completed" class="update-status-btn flex-1 px-3 py-2 bg-green-400 text-white rounded-full font-semibold hover:bg-green-500 transition-colors ${order.status === 'completed' ? 'opacity-50 cursor-not-allowed' : ''}" ${order.status === 'completed' ? 'disabled' : ''}>
                                            ပြီးစီး
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        ordersContainer.insertAdjacentHTML('beforeend', orderHtml);
                    });

                    document.querySelectorAll('.update-status-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            if (!e.target.disabled) {
                                const orderId = e.target.dataset.orderId;
                                const newStatus = e.target.dataset.status;
                                updateOrderStatus(orderId, newStatus);
                            }
                        });
                    });
                }
                lucide.createIcons();
            });
            
            // Foods Listener
            onSnapshot(foodsCollectionRef, (snapshot) => {
                foodManagementContainer.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const food = { id: doc.id, ...doc.data() };
                    const cardHtml = `
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
                            <img src="${food.image_url}" alt="${food.name_mm}" class="w-full h-40 object-cover">
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-xl font-bold text-gray-800">${food.name_mm}</h3>
                                <p class="text-lg font-semibold text-orange-500 my-2">${food.price} ကျပ်</p>
                                <p class="text-gray-600 text-sm mb-4 flex-grow">${food.description_mm}</p>
                                <div class="flex space-x-2 mt-auto">
                                    <button data-food-id="${food.id}" class="edit-food-btn flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit-3"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4z"/><path d="M16 5l3 3"/></svg>
                                        <span>ပြင်ဆင်မည်</span>
                                    </button>
                                    <button data-food-id="${food.id}" class="delete-food-btn flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-red-500 text-white rounded-full font-semibold hover:bg-red-600 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                        <span>ဖျက်မည်</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    foodManagementContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
                
                document.querySelectorAll('.edit-food-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const foodId = e.target.closest('button').dataset.foodId;
                        const foodToEdit = snapshot.docs.find(doc => doc.id === foodId).data();
                        openFoodModal({ id: foodId, ...foodToEdit });
                    });
                });
                
                document.querySelectorAll('.delete-food-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const foodId = e.target.closest('button').dataset.foodId;
                        openDeleteModal(foodId);
                    });
                });
                lucide.createIcons();
            });
        };

        const updateOrderStatus = async (orderId, newStatus) => {
            if (!isAuthReady) return;
            try {
                const orderDocRef = doc(db, `/artifacts/${APP_ID}/public/data/orders`, orderId);
                await updateDoc(orderDocRef, {
                    status: newStatus,
                });
                console.log(`Order ${orderId} status updated to ${newStatus}`);
            } catch (error) {
                console.error("မှာယူမှု အခြေအနေကို ပြောင်းလဲရာတွင် အမှားဖြစ်ပွားသည်: ", error);
            }
        };
        
        // Food Modal ကို ဖွင့်ပြီး Add/Edit အတွက် ပြင်ဆင်ခြင်း
        const openFoodModal = (food = null) => {
            foodModal.classList.remove('hidden');
            foodModalMessage.classList.add('hidden');
            
            if (food) {
                foodModalTitle.textContent = 'မီနူး ပြင်ဆင်မည်';
                foodSubmitBtn.textContent = 'ပြင်ဆင်မည်';
                currentEditingFoodId = food.id;
                document.getElementById('food-name').value = food.name_mm;
                document.getElementById('food-price').value = food.price;
                document.getElementById('food-description').value = food.description_mm;
                document.getElementById('food-image-url').value = food.image_url;
                document.getElementById('food-delivery-fee').value = food.delivery_fee;
                document.getElementById('food-discount-percent').value = food.discount_percent;
            } else {
                foodModalTitle.textContent = 'မီနူး အသစ်ထည့်မည်';
                foodSubmitBtn.textContent = 'ထည့်သွင်းမည်';
                currentEditingFoodId = null;
                foodForm.reset();
            }
            lucide.createIcons();
        };
        
        // Food Modal ပိတ်ရန်
        document.getElementById('close-food-modal-btn').addEventListener('click', () => {
            foodModal.classList.add('hidden');
        });
        
        // Food Form ကို Submit လုပ်ရန်
        foodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;

            const foodData = {
                name_mm: document.getElementById('food-name').value,
                price: Number(document.getElementById('food-price').value),
                description_mm: document.getElementById('food-description').value,
                image_url: document.getElementById('food-image-url').value,
                delivery_fee: Number(document.getElementById('food-delivery-fee').value),
                discount_percent: Number(document.getElementById('food-discount-percent').value),
            };

            const foodCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/foods`);
            
            try {
                if (currentEditingFoodId) {
                    const foodDocRef = doc(foodCollectionRef, currentEditingFoodId);
                    await updateDoc(foodDocRef, foodData);
                    foodModalMessage.textContent = 'မီနူး အောင်မြင်စွာ ပြင်ဆင်ပြီးပါပြီ။';
                } else {
                    await addDoc(foodCollectionRef, foodData);
                    foodModalMessage.textContent = 'မီနူး အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။';
                }
                foodModalMessage.classList.remove('hidden');
                foodModalMessage.classList.remove('bg-red-100', 'text-red-700');
                foodModalMessage.classList.add('bg-green-100', 'text-green-700');
                
                setTimeout(() => {
                    foodModal.classList.add('hidden');
                }, 1500);
            } catch (error) {
                console.error("မီနူး ထည့်သွင်း/ပြင်ဆင်ရာတွင် အမှားဖြစ်ပွားသည်:", error);
                foodModalMessage.textContent = 'လုပ်ဆောင်မှု မအောင်မြင်ပါ၊ နောက်မှ ထပ်ကြိုးစားပါ။';
                foodModalMessage.classList.remove('hidden');
                foodModalMessage.classList.remove('bg-green-100', 'text-green-700');
                foodModalMessage.classList.add('bg-red-100', 'text-red-700');
            }
        });
        
        // Add New Food Button အတွက် event listener
        document.getElementById('open-food-modal-btn').addEventListener('click', () => {
            openFoodModal();
        });
        
        // Delete Modal ကို ဖွင့်ရန်
        const openDeleteModal = (foodId) => {
            deleteModal.dataset.foodId = foodId;
            deleteModal.classList.remove('hidden');
        };
        
        // Delete Cancel Button အတွက် event listener
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            deleteModal.dataset.foodId = null;
        });
        
        // Delete Confirm Button အတွက် event listener
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!isAuthReady) return;
            const foodId = deleteModal.dataset.foodId;
            if (foodId) {
                try {
                    const foodDocRef = doc(db, `/artifacts/${APP_ID}/public/data/foods`, foodId);
                    await deleteDoc(foodDocRef);
                    console.log(`Food item ${foodId} deleted successfully.`);
                } catch (error) {
                    console.error("မီနူး ဖျက်ရာတွင် အမှားဖြစ်ပွားသည်:", error);
                }
            }
            deleteModal.classList.add('hidden');
            deleteModal.dataset.foodId = null;
        });

        const openOrderModal = (food) => {
            orderModal.classList.remove('hidden');
            let phoneNumber = '';
            let address = '';
            let paymentMethod = 'cash';
            let message = '';
            let messageType = '';
            let foodPairingSuggestion = '';
            let isGeneratingSuggestion = false;
            let paymentScreenshot = null;
            let transactionId = '';
            let paymentDate = '';

            const deliveryFee = food.delivery_fee;
            const discountPercent = food.discount_percent;
            const mockAdminAccount = {
                kpay: { accountName: "Foodie Myanmar", phoneNumber: "09-123456789" },
                wave: { accountName: "Foodie Myanmar", phoneNumber: "09-987654321" }
            };

            const calculateTotalCost = () => {
                const discountedPrice = food.price * (1 - food.discount_percent / 100);
                return discountedPrice + food.delivery_fee;
            };

            const renderModalContent = () => {
                const totalCost = calculateTotalCost();
                orderModal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl w-11/12 md:w-1/2 lg:w-1/3 p-6 max-h-screen overflow-y-auto modal-content animate-fade-in">
                        <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">မှာယူရန်</h3>
                        <div class="mb-4 text-center">
                            <img src="${food.image_url}" alt="${food.name_mm}" class="w-full h-40 object-cover rounded-xl mb-2" />
                            <p class="text-xl font-bold">${food.name_mm}</p>
                            <p class="text-lg font-semibold text-orange-500">${food.price} ကျပ်</p>
                        </div>
                        
                        <form id="order-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ဆက်သွယ်ရန် ဖုန်းနံပါတ်</label>
                                    <input type="tel" id="phone-number" value="${phoneNumber}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="ဖုန်းနံပါတ် ထည့်သွင်းပါ" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ပို့ဆောင်ရန် လိပ်စာ</label>
                                    <textarea id="address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="အိမ်နံပါတ်၊ လမ်း၊ မြို့၊ စသဖြင့် ထည့်သွင်းပါ" rows="3" required>${address}</textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ငွေချေမည့်နည်းလမ်း</label>
                                    <div class="flex flex-col space-y-3">
                                        <label class="flex items-center p-3 border rounded-lg cursor-pointer transition-colors ${paymentMethod === 'cash' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:bg-gray-50'}">
                                            <input type="radio" name="payment" value="cash" ${paymentMethod === 'cash' ? 'checked' : ''} class="h-4 w-4 text-orange-600 focus:ring-orange-500" />
                                            <div class="ml-3 flex items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card text-gray-500 mr-2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
                                                <span class="font-medium text-gray-800">ငွေသားနဲ့ပေးချေမည် (Cash On Delivery)</span>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg cursor-pointer transition-colors ${paymentMethod === 'kpay' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:bg-gray-50'}">
                                            <input type="radio" name="payment" value="kpay" ${paymentMethod === 'kpay' ? 'checked' : ''} class="h-4 w-4 text-orange-600 focus:ring-orange-500" />
                                            <div class="ml-3 flex items-center">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/KBZ_Pay_Logo.svg/1200px-KBZ_Pay_Logo.svg.png" alt="KBZ Pay" class="h-5 w-5 mr-2" />
                                                <span class="font-medium text-gray-800">KBZ Pay</span>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-3 border rounded-lg cursor-pointer transition-colors ${paymentMethod === 'wave' ? 'border-orange-500 bg-orange-50' : 'border-gray-300 hover:bg-gray-50'}">
                                            <input type="radio" name="payment" value="wave" ${paymentMethod === 'wave' ? 'checked' : ''} class="h-4 w-4 text-orange-600 focus:ring-orange-500" />
                                            <div class="ml-3 flex items-center">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/Wave_Money_logo.svg/1280px-Wave_Money_logo.svg.png" alt="Wave Money" class="h-5 w-10 mr-2" />
                                                <span class="font-medium text-gray-800">Wave Money</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                ${paymentMethod === 'kpay' ? `
                                <div class="p-4 bg-orange-100 border border-orange-200 rounded-lg animate-fade-in">
                                    <p class="font-bold text-orange-700 flex items-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake mr-2"><path d="m11 17 2 2-2 2"/><path d="m11 17-5-5L2 12l2-2 4 4 4-4 2 2z"/><path d="M15 17v2a2 2 0 1 0 4 0v-2a2 2 0 1 0-4 0z"/><path d="M15 17h-2"/><path d="M11 17H7"/><path d="M11 17V7a2 2 0 1 0-4 0v10a2 2 0 1 0 4 0z"/><path d="M11 17h-2"/></svg>
                                        ငွေပေးချေမှု လမ်းညွှန်ချက် (KBZ Pay)
                                    </p>
                                    <p class="text-gray-800 text-sm">
                                        ကျေးဇူးပြု၍ စုစုပေါင်း ကုန်ကျစရိတ်ဖြစ်တဲ့ **${totalCost} ကျပ်** ကို အောက်ပါ KBZ Pay အကောင့်သို့ လွှဲပေးပါ။
                                    </p>
                                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1">
                                        <li>**အမည်:** ${mockAdminAccount.kpay.accountName}</li>
                                        <li>**ဖုန်းနံပါတ်:** ${mockAdminAccount.kpay.phoneNumber}</li>
                                    </ul>
                                </div>
                                ` : ''}
                                ${paymentMethod === 'wave' ? `
                                <div class="p-4 bg-orange-100 border border-orange-200 rounded-lg animate-fade-in">
                                    <p class="font-bold text-orange-700 flex items-center mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-handshake mr-2"><path d="m11 17 2 2-2 2"/><path d="m11 17-5-5L2 12l2-2 4 4 4-4 2 2z"/><path d="M15 17v2a2 2 0 1 0 4 0v-2a2 2 0 1 0-4 0z"/><path d="M15 17h-2"/><path d="M11 17H7"/><path d="M11 17V7a2 2 0 1 0-4 0v10a2 2 0 1 0 4 0z"/><path d="M11 17h-2"/></svg>
                                        ငွေပေးချေမှု လမ်းညွှန်ချက် (Wave Money)
                                    </p>
                                    <p class="text-gray-800 text-sm">
                                        ကျေးဇူးပြု၍ စုစုပေါင်း ကုန်ကျစရိတ်ဖြစ်တဲ့ **${totalCost} ကျပ်** ကို အောက်ပါ Wave Money အကောင့်သို့ လွှဲပေးပါ။
                                    </p>
                                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1">
                                        <li>**အမည်:** ${mockAdminAccount.wave.accountName}</li>
                                        <li>**ဖုန်းနံပါတ်:** ${mockAdminAccount.wave.phoneNumber}</li>
                                    </ul>
                                </div>
                                ` : ''}
                                
                                ${paymentMethod !== 'cash' ? `
                                <div class="mt-4 space-y-4 p-4 bg-orange-50 rounded-xl">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text mr-2"><path d="M4 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4z"/><path d="M8 8h8"/><path d="M8 12h8"/><path d="M8 16h6"/></svg>
                                            ငွေလွှဲထားသည့် Transaction ID
                                        </label>
                                        <input type="text" id="transaction-id" value="${transactionId}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Transaction ID ထည့်သွင်းပါ" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days mr-2"><path d="M8 2v4"/><path d="M16 2v4"/><rect x="2" y="4" width="20" height="18" rx="2"/><path d="M2 10h20"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                                            ငွေလွှဲသည့်ရက်စွဲ (Date)
                                        </label>
                                        <input type="date" id="payment-date" value="${paymentDate}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera mr-2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M10 14h4"/><path d="M12 14v-4"/></svg>
                                            ငွေလွှဲထားသည့် Screenshot
                                        </label>
                                        <input type="file" id="screenshot-upload" accept="image/*" class="w-full text-gray-700 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" ${paymentScreenshot ? '' : 'required'} />
                                    </div>
                                    ${paymentScreenshot ? `
                                        <div class="mt-4">
                                            <p class="text-xs text-gray-500 mb-2">Preview:</p>
                                            <img src="${paymentScreenshot}" alt="Payment Screenshot" class="w-full h-auto rounded-lg shadow-md" />
                                        </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>

                            <div class="mt-6 p-4 bg-orange-50 rounded-xl">
                                <h4 class="text-md font-bold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles text-orange-500 mr-2"><path d="M9.916 4.965a.5.5 0 0 1 .353-.146h4.662a.5.5 0 0 1 .353.146l4.636 4.636a.5.5 0 0 1 0 .707l-4.636 4.636a.5.5 0 0 1-.353.146h-4.662a.5.5 0 0 1-.353-.146l-4.636-4.636a.5.5 0 0 1 0-.707z"/><path d="M12 21v2"/><path d="M21 12h2"/><path d="M2 12h2"/><path d="M12 2v2"/></svg>
                                    အစားအသောက် လိုက်ဖက်မှု အကြံပြုချက်များ
                                </h4>
                                <div class="flex flex-col space-y-2">
                                    <button type="button" id="get-pairing-suggestion-btn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-white text-orange-500 rounded-full font-semibold shadow-md border-2 border-orange-200 hover:bg-gray-100 transition-colors ${isGeneratingSuggestion ? 'opacity-50 cursor-not-allowed' : ''}" ${isGeneratingSuggestion ? 'disabled' : ''}>
                                        ${isGeneratingSuggestion ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw animate-spin"><path d="M2 12a10 10 0 0 0 10 10v-2a8 8 0 0 1-8-8z"/><path d="M22 12A10 10 0 0 0 12 2v2a8 8 0 0 1 8 8z"/><path d="M12 2v2a8 8 0 0 1 8 8h2a10 10 0 0 0-10-10z"/><path d="M22 12h-2a8 8 0 0 1-8 8v2a10 10 0 0 0 10-10z"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="M9.916 4.965a.5.5 0 0 1 .353-.146h4.662a.5.5 0 0 1 .353.146l4.636 4.636a.5.5 0 0 1 0 .707l-4.636 4.636a.5.5 0 0 1-.353.146h-4.662a.5.5 0 0 1-.353-.146l-4.636-4.636a.5.5 0 0 1 0-.707z"/><path d="M12 21v2"/><path d="M21 12h2"/><path d="M2 12h2"/><path d="M12 2v2"/></svg>`}
                                        <span>အကြံပြုချက်များ ရယူမည်</span>
                                    </button>
                                    ${isGeneratingSuggestion ? `<p class="text-center text-sm text-gray-500 mt-2">အကြံပြုချက်များ ထုတ်လုပ်နေသည်...</p>` : ''}
                                    ${foodPairingSuggestion ? `
                                        <div class="mt-2 p-3 bg-white rounded-lg shadow-inner text-gray-700 whitespace-pre-wrap">
                                            ${foodPairingSuggestion}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="mt-6 p-4 bg-orange-50 rounded-xl">
                                <h4 class="text-md font-bold text-gray-800 flex items-center mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-dollar-sign text-orange-500 mr-2"><path d="M16.5 3c-.9-1.2-2.1-2-3.5-2a6.34 6.34 0 0 0-4 4.5c0 .7-.1 1.4-.4 2H7c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2h2v4a2 2 0 0 0 2 2h4c1.1 0 2-.9 2-2v-4h2c1.1 0 2-.9 2-2v-4c0-1.1-.9-2-2-2h-2.1c-.3-.6-.6-1.2-.9-1.7zm0 0a6.34 6.34 0 0 0 4.5-4h-4.5V1H14c-1.4 0-2.6.8-3.5 2z"/><path d="M12 8v8"/><path d="M10 13h4"/></svg>
                                    ကုန်ကျစရိတ် အသေးစိတ်
                                </h4>
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span class="text-gray-600">အစားအသောက် စျေးနှုန်း:</span>
                                    <span class="font-semibold">${food.price} ကျပ်</span>
                                </div>
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span class="text-gray-600">Deli Fee:</span>
                                    <span class="font-semibold">${food.delivery_fee} ကျပ်</span>
                                </div>
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span class="text-gray-600">Discount:</span>
                                    <span class="font-semibold text-green-600">${food.discount_percent}%</span>
                                </div>
                                <div class="flex justify-between items-center text-lg font-bold text-gray-800 mt-2 border-t pt-2 border-orange-200">
                                    <span>စုစုပေါင်း ကုန်ကျစရိတ်:</span>
                                    <span>${totalCost} ကျပ်</span>
                                </div>
                            </div>

                            ${message ? `<div id="order-message" class="mt-4 p-3 rounded-lg text-sm text-center ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${message}</div>` : ''}
                            
                            <div class="mt-6 flex justify-end space-x-4">
                                <button type="button" id="close-modal-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full font-semibold hover:bg-gray-300 transition-colors">ဖျက်သိမ်းမည်</button>
                                <button type="submit" class="px-6 py-3 bg-orange-500 text-white rounded-full font-semibold shadow-lg hover:bg-orange-600 transition-colors">မှာယူမည်</button>
                            </div>
                        </form>
                    </div>
                `;
                lucide.createIcons();
                
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                
                const form = document.getElementById('order-form');
                form.addEventListener('submit', handlePlaceOrder);

                const phoneNumberInput = document.getElementById('phone-number');
                phoneNumberInput.value = phoneNumber;
                phoneNumberInput.addEventListener('input', (e) => { phoneNumber = e.target.value; });

                const addressTextarea = document.getElementById('address');
                addressTextarea.value = address;
                addressTextarea.addEventListener('input', (e) => { address = e.target.value; });

                const paymentRadios = form.querySelectorAll('input[name="payment"]');
                paymentRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        paymentMethod = e.target.value;
                        renderModalContent(); 
                    });
                });

                if (paymentMethod !== 'cash') {
                    const screenshotUpload = document.getElementById('screenshot-upload');
                    screenshotUpload.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                paymentScreenshot = reader.result;
                                renderModalContent();
                            };
                            reader.readAsDataURL(file);
                        } else {
                            paymentScreenshot = null;
                            renderModalContent();
                        }
                    });

                    const transactionIdInput = document.getElementById('transaction-id');
                    if (transactionIdInput) {
                      transactionIdInput.value = transactionId;
                      transactionIdInput.addEventListener('input', (e) => { transactionId = e.target.value; });
                    }

                    const paymentDateInput = document.getElementById('payment-date');
                    if (paymentDateInput) {
                      paymentDateInput.value = paymentDate;
                      paymentDateInput.addEventListener('input', (e) => { paymentDate = e.target.value; });
                    }
                }

                document.getElementById('get-pairing-suggestion-btn').addEventListener('click', async () => {
                    isGeneratingSuggestion = true;
                    foodPairingSuggestion = '';
                    renderModalContent();
                    try {
                        const prompt = `အောက်ပါအစားအစာနဲ့ လိုက်ဖက်တဲ့ အစားအသောက် (သို့မဟုတ်) အဖျော်ယမကာ ၃ ခုကို အကြံပြုပေးပါ။ မြန်မာလိုပဲပြန်ဖြေပေးပါ။ "${food.name_mm}"`;
                        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            foodPairingSuggestion = text;
                        } else {
                            foodPairingSuggestion = 'အကြံပြုချက်များရယူရန် မအောင်မြင်ပါ။';
                        }
                    } catch (error) {
                        console.error("Gemini API call failed:", error);
                        foodPairingSuggestion = 'အမှားတစ်ခုခုဖြစ်သွားပါသည်။';
                    } finally {
                        isGeneratingSuggestion = false;
                        renderModalContent();
                    }
                });
            };

            const handlePlaceOrder = async (e) => {
                e.preventDefault();
                if (!isAuthReady) {
                    message = 'Database ကိုချိတ်ဆက်၍မရပါ၊ ခဏအကြာတွင် ထပ်ကြိုးစားပါ။';
                    messageType = 'error';
                    renderModalContent();
                    return;
                }
                
                if (paymentMethod !== 'cash') {
                    if (!paymentScreenshot || !transactionId || !paymentDate) {
                        message = 'ငွေလွှဲထားသည့် screenshot၊ Transaction ID နှင့် ရက်စွဲကို ဖြည့်သွင်းပါ။';
                        messageType = 'error';
                        renderModalContent();
                        return;
                    }
                }

                try {
                    const ordersCollectionRef = collection(db, `/artifacts/${APP_ID}/public/data/orders`);
                    const orderData = {
                        foodId: food.id,
                        foodName_mm: food.name_mm,
                        price: food.price,
                        deliveryFee: food.delivery_fee,
                        discountPercent: food.discount_percent,
                        totalCost: calculateTotalCost(),
                        phoneNumber: phoneNumber,
                        address: address,
                        status: 'pending',
                        paymentMethod: paymentMethod,
                        screenshot: paymentScreenshot,
                        timestamp: new Date().toISOString(),
                        userId: userId,
                        transactionId: transactionId,
                        paymentDate: paymentDate,
                        adminPhoneNumber: paymentMethod === 'kpay' ? mockAdminAccount.kpay.phoneNumber : (paymentMethod === 'wave' ? mockAdminAccount.wave.phoneNumber : null),
                    };

                    await addDoc(ordersCollectionRef, orderData);

                    message = 'မှာယူမှုအောင်မြင်ပါသည်။';
                    messageType = 'success';
                    renderModalContent();
                    setTimeout(closeModal, 2000);
                } catch (error) {
                    console.error("မှာယူမှုပြုလုပ်ရာတွင် အမှားဖြစ်ပွားသည်: ", error);
                    message = 'မှာယူမှု မအောင်မြင်ပါ။ နောက်မှ ထပ်ကြိုးစားပါ။';
                    messageType = 'error';
                    renderModalContent();
                }
            };
            
            renderModalContent();
        };

        const closeModal = () => {
            orderModal.classList.add('hidden');
        };

        const getStatusDisplay = (status) => {
            switch (status) {
                case 'pending': return { text: 'ဆောင်ရွက်ဆဲ', style: 'bg-yellow-100 text-yellow-700', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-open"><path d="M10.5 13.5a2.5 2.5 0 0 0-5 0v3.25a2.5 2.5 0 0 0 5 0V17z"/><path d="M12 2v20h9a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/><path d="M12 22a9 9 0 0 1-9-9V4a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v9a2.5 2.5 0 0 1-2.5 2.5z"/></svg>` };
                case 'in_delivery': return { text: 'ပို့ဆောင်နေသည်', style: 'bg-blue-100 text-blue-700', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-truck"><path d="M10 17H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M17 17h-2"/><path d="M12 9V3a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v6"/><path d="M21 17h-2"/><path d="M19 12h-2"/></svg>` };
                case 'completed': return { text: 'ပြီးစီး', style: 'bg-green-100 text-green-700', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.6"/><path d="M22 4L12 14.01l-3-3"/></svg>` };
                default: return { text: 'မသိရှိ', style: 'bg-gray-100 text-gray-700', icon: null };
            }
        };

        const getPaymentDisplay = (paymentMethod) => {
            switch (paymentMethod) {
                case 'cash': return { text: 'ငွေသား', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card text-gray-500"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>` };
                case 'kpay': return { text: 'KBZ Pay', icon: `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/KBZ_Pay_Logo.svg/1200px-KBZ_Pay_Logo.svg.png" alt="KBZ Pay" class="h-4 w-4" />` };
                case 'wave': return { text: 'Wave Money', icon: `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/Wave_Money_logo.svg/1280px-Wave_Money_logo.svg.png" alt="Wave Money" class="h-4 w-8" />` };
                default: return { text: 'မသိရှိ', icon: null };
            }
        };
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>
